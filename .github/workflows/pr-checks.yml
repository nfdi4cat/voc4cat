# This workflow checks for common PR submission issues
# and provides helpful feedback to contributors

name: PR Submission Checks

on:
  pull_request_target:
    types: [opened, reopened, synchronize]
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  check-pr-submission:
    name: Check PR submission best practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if PR is from main branch of fork
        id: check-main-branch
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const headRef = pr.head.ref;
            const headRepo = pr.head.repo.full_name;
            const baseRepo = pr.base.repo.full_name;
            const isFork = headRepo !== baseRepo;
            const isFromMain = headRef === 'main';
            const isFromOrg = pr.head.repo.owner.type === 'Organization';
            
            console.log(`PR #${pr.number} details:`);
            console.log(`  Head branch: ${headRef}`);
            console.log(`  Head repo: ${headRepo}`);
            console.log(`  Base repo: ${baseRepo}`);
            console.log(`  Is fork: ${isFork}`);
            console.log(`  From main branch: ${isFromMain}`);
            console.log(`  Owner type: ${pr.head.repo.owner.type}`);
            
            core.setOutput('is_fork', isFork);
            core.setOutput('is_from_main', isFromMain);
            core.setOutput('is_from_org', isFromOrg);
            core.setOutput('head_ref', headRef);
            core.setOutput('head_repo', headRepo);
            
            return {
              isFork,
              isFromMain,
              isFromOrg,
              needsComment: isFork && isFromMain
            };

      - name: Post comment about main branch submission
        if: steps.check-main-branch.outputs.is_fork == 'true' && steps.check-main-branch.outputs.is_from_main == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if we already posted this comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('submitted from the main branch')
            );
            
            if (botComment) {
              console.log('Comment about main branch already exists, skipping');
              return;
            }
            
            // Post helpful comment
            const commentBody = `## ‚ö†Ô∏è Pull Request Submitted from Main Branch

Hi @${pr.user.login}! üëã

Thank you for your contribution to voc4cat! 

We noticed that this pull request was submitted from the \`main\` branch of your fork. While this works, it can make it difficult to keep your fork synchronized with the main repository and may cause issues when making future contributions.

### Why is this problematic?

- It makes it harder to update your fork with changes from the upstream repository
- You won't be able to work on multiple pull requests simultaneously
- Future updates to the main repository may create conflicts in your fork

### How to fix this (for future PRs):

1. **Create a new branch for your changes:**
   \`\`\`bash
   git checkout -b descriptive-branch-name
   \`\`\`

2. **Make your changes and commit them to this branch**

3. **Push the branch to your fork:**
   \`\`\`bash
   git push origin descriptive-branch-name
   \`\`\`

4. **Create your pull request from this new branch**

### For this current PR:

You don't need to close this PR. We can still merge it! However, for your next contribution, please consider using a feature branch as described above.

For more information, see our [Contributing Guidelines](https://github.com/nfdi4cat/voc4cat/blob/main/CONTRIBUTING.md).

---
*This is an automated message to help improve the contribution workflow. If you have any questions, please don't hesitate to ask!* üöÄ`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: commentBody
            });

      - name: Post info about organization account
        if: steps.check-main-branch.outputs.is_from_org == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if we already posted this comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('organization account')
            );
            
            if (botComment) {
              console.log('Comment about organization account already exists, skipping');
              return;
            }
            
            const commentBody = `## ‚ö†Ô∏è Pull Request from Organization Account

Hi @${pr.user.login}! üëã

We noticed that this pull request comes from an organization account rather than a personal account. 

### Why this is problematic:

GitHub does not allow the "Allow edits from maintainers" option for forks stored in an organization (see [GitHub Community Discussion](https://github.com/orgs/community/discussions/5634)). This option is **required** for PRs in voc4cat because our CI workflow needs to:
- Commit the generated turtle files from your submitted Excel file
- Remove the Excel file from the inbox after processing

**Without this permission, the CI workflow will fail and your PR cannot be merged.**

### How to fix this:

You need to transfer this PR to a personal account:

1. Fork the voc4cat repository to your **personal GitHub account** (not an organization)
2. Create a new branch with your changes in your personal fork
3. Submit a new PR from your personal fork
4. Close this PR

If you need help with this process, please let us know!

---
*This is an automated check. Organization forks cannot be used for contributions to voc4cat due to GitHub limitations.* üö´`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: commentBody
            });

